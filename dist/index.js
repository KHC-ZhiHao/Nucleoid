"use strict";var _createClass=function(){function i(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(t,e,n){return e&&i(t.prototype,e),n&&i(t,n),t}}(),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};function _toConsumableArray(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)}function _asyncToGenerator(t){return function(){var a=t.apply(this,arguments);return new Promise(function(r,s){return function e(t,n){try{var i=a[t](n),o=i.value}catch(t){return void s(t)}if(!i.done)return Promise.resolve(o).then(function(t){e("next",t)},function(t){e("throw",t)});r(o)}("next")})}}function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}!function(t,e){"undefined"!=typeof module&&"object"===("undefined"==typeof exports?"undefined":_typeof(exports))?module.exports=e():"function"==typeof define&&(define.amd||define.cmd)?define(function(){return e}):t.Nucleoid=e()}("undefined"!=typeof window?window:global,function(){var s=function(){function e(t){_classCallCheck(this,e),this.$moduleBase={name:t||"no name"}}return _createClass(e,[{key:"$systemError",value:function(t,e){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"$_no_error";throw"$_no_error"!==n&&(console.log("%c error object is : ","color:#FFF; background:red"),console.log(n)),new Error("(☉д⊙)!! Nucleoid::"+this.$moduleBase.name+" => "+t+" -> "+e)}},{key:"$noKey",value:function(t,e,n){return null==e[n]||(this.$systemError(t,"Name already exists.",n),!1)}},{key:"$verify",value:function(t,e){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},i={};for(var o in e){var r=e[o];if(r[0]&&null==t[o])return void this.$systemError("verify","Must required",o);t[o]?_typeof(r[1])!==("string"==typeof t[o]&&"#"===t[o][0])||t[o].slice(1)?i[o]=t[o]:this.$systemError("verify","Type("+_typeof(r[1])+") error",o):i[o]=r[1]}return Object.assign(i,n)}},{key:"$protection",value:function(t,e,n,i){var o=this;n[e]=i,Object.defineProperty(t,e,{set:function(){o.$systemError("protection","This key is a private key, can't be change.",e)},get:function(){return n[e]}})}}]),e}(),r=function t(){_classCallCheck(this,t)},i=function(t){function n(t){_classCallCheck(this,n);var e=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,"Root"));return e.name=t,e.delay=10,e.startTime=0,e.operating="undefined"==typeof window?"node":"browser",e.pollingEvents=[],e}return _inherits(n,s),_createClass(n,[{key:"install",value:function(){this.status=new u(this,null,this.name,"root"),this.startTime=Date.now(),this.initPolling()}},{key:"initPolling",value:function(){var i=this;this.interval=setInterval(function(){for(var t=!1,e=0;e<i.pollingEvents.length;e++){var n=i.pollingEvents[e];n.finish?t=!0:n.activate()}t&&i.filterPollingEvents()},this.delay)}},{key:"polling",value:function(t,e){this.pollingEvents.push(new o(this,e||this.status,t))}},{key:"clearPollingEvents",value:function(){this.pollingEvents=this.pollingEvents.filter(function(t){return!1===t.finish})}},{key:"createFragment",value:function(t,e){return new a(this,e||this.status,t).use()}},{key:"bindFragment",value:function(e){var n=this;return function(t){return n.createFragment(t,e)}}},{key:"bindPolling",value:function(e){var n=this;return function(t){return n.polling(t,e)}}},{key:"close",value:function(){clearInterval(this.interval)}},{key:"operationTime",get:function(){return Date.now()-this.startTime}}]),n}(),o=function(t){function o(t,e,n){_classCallCheck(this,o);var i=_possibleConstructorReturn(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,"PollingEvent"));return i.status=new u(t,e,n.name,"polling"),i.action=n.action,i.finish=!1,i}return _inherits(o,s),_createClass(o,[{key:"activate",value:function(){this.action(this.close.bind(this))}},{key:"close",value:function(){this.finish=!0,this.status.set(!0)}}]),o}(),a=function(t){function o(t,e,n){_classCallCheck(this,o);var i=_possibleConstructorReturn(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,"Fragment"));return i.root=t,i.over=0,i.name=n||"no name",i.stop=!1,i.thread=[],i.status=new u(i.root,e,i.name,"fragment"),i}return _inherits(o,s),_createClass(o,[{key:"install",value:function(t){this.callback=t}},{key:"use",value:function(){return{add:this.add.bind(this),activate:this.activate.bind(this)}}},{key:"add",value:function(t){this.thread.push(this.$verify(t,{name:[!0,"#string"],action:[!0,"#function"]}))}},{key:"regsterError",value:function(e){var n=this;return function(t){e.set(!1,t),!1===n.stop&&(n.stop=!0,n.status.set(!1,t),n.callback(t))}}},{key:"regsterOnload",value:function(t){var e=this;return function(){t.set(!0),e.over+=1,!1===e.stop&&e.over>=e.thread.length&&(e.stop=!0,e.status.set(!0),e.callback())}}},{key:"actionThread",value:function(o){var t,r=this;(t=_asyncToGenerator(regeneratorRuntime.mark(function t(){var e,n,i;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:e=new u(r.root,r.status,o.name,"fragment-base"),n=r.regsterOnload(e),i=r.regsterError(e),o.action(i,n);case 4:case"end":return t.stop()}},t,r)})),function(){return t.apply(this,arguments)})()}},{key:"activate",value:function(t){var e=this,n=this.thread.length;this.install(t);for(var i=0;i<n;i++)this.actionThread(this.thread[i]);0===n&&this.callback(null),this.activate=function(){e.$systemError("activate","This template("+e.name+") already  called")}}}]),o}(),u=function(t){function r(t,e,n,i){_classCallCheck(this,r);var o=_possibleConstructorReturn(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,"Status"));return o.root=t||null,o.name=n||"no name",o.type=i||"no type",o.parent=e,o.message="",o.success=!1,o.children=[],o.attributes={},o.operationTime=0,o.parent&&o.parent.addChildren(o),o}return _inherits(r,s),_createClass(r,[{key:"add",value:function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:null;this.attributes[t]=e||""}},{key:"set",value:function(t,e){this.success=t,this.message=e||"",this.operationTime=this.root.operationTime}},{key:"get",value:function(){var t={name:this.name,type:this.type,message:this.message,success:this.success,attributes:this.attributes,children:[],operationTime:this.operationTime},e=!0,n=!1,i=void 0;try{for(var o,r=this.children[Symbol.iterator]();!(e=(o=r.next()).done);e=!0){var s=o.value;t.children.push(s.get())}}catch(t){n=!0,i=t}finally{try{!e&&r.return&&r.return()}finally{if(n)throw i}}return t}},{key:"json",value:function(){return JSON.stringify(this.get(),null,4)}},{key:"addChildren",value:function(t){t instanceof r?this.children.push(t):this.$systemError("addChildren","Child not a status class.",t)}}]),r}(),c=function(t){function i(t,e){_classCallCheck(this,i);var n=_possibleConstructorReturn(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,"Curry"));return n.group=e,n.data=n.$verify(t,{name:[!0,""],input:[!0,"#function"],output:[!0,"#function"],methods:[!0,{}]}),n.checkPrivateKey(),n}return _inherits(i,s),_createClass(i,[{key:"checkPrivateKey",value:function(){var t=this.data.methods;(t.action||t.promise)&&this.$systemError("init","Methods has private key(action, promise, direct)")}},{key:"use",value:function(){var e=this;return function(t){return new n(e,t).getRegisterMethod()}}},{key:"name",get:function(){return this.data.name}}]),i}(),n=function(t){function i(t,e){_classCallCheck(this,i);var n=_possibleConstructorReturn(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,"CurryUnit"));return n.case=new r,n.flow=[],n.main=t,n.index=0,n.params=e,n.previousFlow=null,n.initRegisterMethod(),n}return _inherits(i,s),_createClass(i,[{key:"initRegisterMethod",value:function(){var e=this,n=this;this.registergMethod={action:this.action.bind(this),promise:this.promise.bind(this)};var t=function(t){e.registergMethod[t]=function(){return n.register(t,[].concat(Array.prototype.slice.call(arguments))),n.getRegisterMethod()}};for(var i in this.main.data.methods)t(i)}},{key:"getRegisterMethod",value:function(){return this.registergMethod}},{key:"register",value:function(t,e){var n={name:t,nextFlow:null,previous:this.flow.slice(-1),index:this.index,method:this.main.data.methods[t],params:e};this.previousFlow&&(this.previousFlow.nextFlow=n),this.previousFlow=n,this.index+=1,this.flow.push(n)}},{key:"include",value:function(t){return this.main.group.getMethod(t).use()}},{key:"action",value:function(e){this.activation(function(t){e(t,null)},function(t){e(null,t)})}},{key:"promise",value:function(){var n=this;return new Promise(function(t,e){n.activation(e,t)})}},{key:"activation",value:function(e,n){var i=this,o=!1,r=0,s=this.include.bind(this),a=function(t){e(t),o=!0},u=function(){r+=1,!1===o&&t()},t=function(){var t=i.flow[r];t?t.method.bind(i.case).apply(void 0,_toConsumableArray(t.params).concat([{index:t.index,include:s,nextFlow:t.nextFlow,previous:t.previous},a,u])):i.main.data.output.bind(i.case)({include:s},function(t){a(t)},function(t){n(t)})},c=function(){t(),c=function(){}};this.main.data.input.bind(this.case)(this.params,{include:s},a,c)}}]),i}(),h=function(t){function n(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,n);var e=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,"MethodGroup"));return e.case=new r,e.pool={},e.curriedPool={},e.data=e.$verify(t,{create:[!1,function(){}]}),e}return _inherits(n,s),_createClass(n,[{key:"create",value:function(t){this.data.create.bind(this.case)(t),this.create=null}},{key:"getMethod",value:function(t){if(this.pool[t])return this.pool[t];this.$systemError("getMethod","method not found.",t)}},{key:"getCurriedFunction",value:function(t){if(this.curriedPool[t])return this.curriedPool[t];this.$systemError("getCurry","curry not found.",t)}},{key:"currying",value:function(t){var e=new c(t,this);this.$noKey("currying",this.curriedPool,e.name)&&(this.curriedPool[e.name]=e)}},{key:"addMethod",value:function(t){var e=new l(t,this);this.$noKey("addMethod",this.pool,e.name)&&(this.pool[e.name]=e)}},{key:"hasCurry",value:function(t){return!!this.curriedPool[t]}},{key:"hasMethod",value:function(t){return!!this.pool[t]}}]),n}(),l=function(t){function i(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{},e=arguments[1];_classCallCheck(this,i);var n=_possibleConstructorReturn(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,"Method"));return n.case=new r,n.store={},n.group=e,n.data=n.$verify(t,{name:[!0,""],create:[!1,function(){}],action:[!0,"#function"],allowDirect:[!1,!0]}),null==n.group&&n.$systemError("init","No has group",n),n}return _inherits(i,s),_createClass(i,[{key:"install",value:function(){this.initBindData(),this.data.create.bind(this.case)(this.bind.create),this.install=null}},{key:"initBindData",value:function(){this.bind={create:{store:this.store,include:this.include.bind(this)},system:{store:this.store,group:this.groupCase,include:this.include.bind(this)},action:this.data.action.bind(this.case)}}},{key:"include",value:function(t){return this.group.getMethod(t).use()}},{key:"direct",value:function(t){!1===this.data.allowDirect&&this.$systemError("direct","Not allow direct.",this.data.name);var e=null;return this.bind.action(t,this.bind.system,function(t){throw new Error(t)},function(t){e=t}),e}},{key:"action",value:function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:function(){};this.bind.action(t,this.bind.system,function(t){e(t,null)},function(t){e(null,t)})}},{key:"promise",value:function(n){var i=this;return new Promise(function(t,e){i.bind.action(n,i.bind.system,t,e)})}},{key:"getStore",value:function(t){if(this.store[t])return this.store[t];this.$systemError("getStore","Key not found.",t)}},{key:"use",value:function(){return this.install&&this.install(),{store:this.getStore.bind(this),direct:this.direct.bind(this),action:this.action.bind(this),promise:this.promise.bind(this)}}},{key:"name",get:function(){return this.data.name}},{key:"groupCase",get:function(){return this.group.case}}]),i}(),f=function(t){function n(t){_classCallCheck(this,n);var e=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,"Gene"));return e.setName(t||"no name"),e.root=new i(e.name),e.templates=[],e.polymerase={messenger:{},protection:{}},e.mode={timeout:null,catchException:null,catchUncaughtException:null},e.synthesis={initiation:null,elongation:null,termination:null},e}return _inherits(n,s),_createClass(n,[{key:"setName",value:function(t){"string"==typeof t?this.name=t:this.$systemError("setName","Name not a string.",t)}},{key:"setTimeoutMode",value:function(t,e,n){"boolean"==typeof t&&"number"==typeof e&&"function"==typeof n?t&&(this.mode.timeout={action:n,millisecond:e}):this.$systemError("setTimeout","Params type error. try setTimeoutMode(boolean, number, function)")}},{key:"setCatchExceptionMode",value:function(t,e){"boolean"==typeof t&&"function"==typeof e?t&&(this.mode.catchException={action:e}):this.$systemError("setCatchExceptionMode","Params type error, try setCatchExceptionMode(boolean, function).")}},{key:"setCatchUncaughtExceptionMode",value:function(t,e){"boolean"==typeof t&&"function"==typeof e?t&&(this.mode.catchUncaughtException={action:e}):this.$systemError("setCatchUncaughtException","Params type error, try setCatchUncaughtException(boolean, function).")}},{key:"addMessenger",value:function(t,e){null==this.polymerase.messenger[t]?"$"===t.slice(0,1)?this.$protection(this.polymerase.messenger,t,this.polymerase.protection,e):this.polymerase.messenger[t]=e:this.$systemError("addMessenger","Messenger key already exists.",t)}},{key:"template",value:function(t,e){"string"==typeof t&&"function"==typeof e?this.templates.push({name:t,action:e}):this.$systemError("template","Params type error, try template(string, function).")}},{key:"setInitiation",value:function(t){"function"==typeof t?this.synthesis.initiation=t:this.$systemError("setInitiation","Params type error, try setInitiation(function).")}},{key:"setElongation",value:function(t){"function"==typeof t?this.synthesis.elongation=t:this.$systemError("setElongation","Params type error, try setElongation(function).")}},{key:"setTermination",value:function(t){"function"==typeof t?this.synthesis.termination=t:this.$systemError("setTermination","Params type error, try setTermination(function).")}},{key:"translation",value:function(){var n=this;return new Promise(function(t,e){n.root.install(),new y(n,t,e)})}}]),n}(),d=new(function(t){function e(){_classCallCheck(this,e);var t=_possibleConstructorReturn(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,"Bioreactor"));return t.groups={},t}return _inherits(e,s),_createClass(e,[{key:"getGroup",value:function(t){return this.groups[t]}},{key:"getMethod",value:function(t,e){return this.getGroup(t).getMethod(e)}},{key:"getCurriedFunction",value:function(t,e){return this.getGroup(t).getCurriedFunction(e)}},{key:"addGroup",value:function(t,e,n){null==this.groups[t]?e instanceof h?(e.create&&e.create(n),this.groups[t]=e):this.$systemError("addGroup","Must group.",e):this.$systemError("addGroup","Name already exists.",t)}},{key:"hasGroup",value:function(t){return!!this.groups[t]}},{key:"hasMethod",value:function(t,e){return!!this.getGroup(t).hasMethod(e)}},{key:"hasCurriedFunction",value:function(t,e){return!!this.getGroup(t).hasCurriedFunction(e)}}]),e}()),y=function(t){function o(t,e,n){_classCallCheck(this,o);var i=_possibleConstructorReturn(this,(o.__proto__||Object.getPrototypeOf(o)).call(this,"Translation"));return i.case=new r,i.gene=t,i.root=t.root,i.status=i.root.status,i.finish=!1,i.reject=n,i.resolve=e,i.templates=i.gene.templates,i.messenger=i.gene.polymerase.messenger,i.bioreactor=d,i.init(),i.synthesis(),i}return _inherits(o,s),_createClass(o,[{key:"init",value:function(){this.initBind(),this.initTimeoutMode(),this.initGenerator(),this.initCatchUncaughtExceptionMode()}},{key:"initBind",value:function(){this.bind={io:this.io.bind(this),exit:this.exit.bind(this),fail:this.fail.bind(this),next:this.next.bind(this),mixin:this.mixin.bind(this),methods:this.methods.bind(this)}}},{key:"initTimeoutMode",value:function(){var e=this;if(this.gene.mode.timeout){var n=this.gene.mode.timeout,t={name:"timeout",action:function(t){e.root.operationTime>n.millisecond&&(e.status.add("timeout"),n.action.bind(e.case)(e.messenger,e.bind.exit,e.bind.fail),t())}};this.root.polling(t)}}},{key:"initCatchUncaughtExceptionMode",value:function(){var n=this;this.gene.mode.catchUncaughtException&&(this.uncaughtExceptionAction=function(t){var e=t.stack?t:t.error;n.status.add("uncaughtException",e.message),n.gene.mode.catchUncaughtException.action.bind(n.case)(n.messenger,e,n.bind.exit,n.bind.fail)},"node"===this.root.operating?(this.uncaughtExceptionDomain=require("domain").create(),this.uncaughtExceptionDomain.on("error",this.uncaughtExceptionAction)):window.addEventListener("error",this.uncaughtExceptionAction))}},{key:"initGenerator",value:function(){var o=this,t=regeneratorRuntime.mark(function t(){var n,i;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:n=0,i=o.templates[0],o.gene.synthesis.initiation&&o.gene.synthesis.initiation.bind(o.case)(o.messenger,o.bind.exit,o.bind.fail);case 3:if(!(n<=1e4)){t.next=13;break}if(o.finish)return t.abrupt("break",13);t.next=8;break;case 8:null==i?o.bind.exit():function(){var t=new u(o.root,o.status,i.name,"template"),e=function(){e=null,t.set(!0),i=o.templates[n++],o.bind.next()};i.action.bind(o.case)(o.messenger,o.getSkill(t),e,o.bind.exit,o.bind.fail)}();case 9:return void(t.next=11);case 11:t.next=3;break;case 13:return t.abrupt("return");case 14:case"end":return t.stop()}},t,this)});this.iterator=t()}},{key:"getSkill",value:function(t){return{io:this.bind.io,mixin:this.bind.mixin,methods:this.bind.methods,polling:this.root.bindPolling(t),createFragment:this.root.bindFragment(t)}}},{key:"methods",value:function(t,e){return this.bioreactor.getMethod(t,e).use()}},{key:"io",value:function(t,e){return this.bioreactor.getCurriedFunction(t,e).use()}},{key:"mixin",value:function(t,e){var n=this;t instanceof f?t.translation().then(function(t){n.status.addChildren(t.status),e(null,t.messenger)},function(t){n.status.addChildren(t.status),e({error:t.error,messenger:t.messenger},null)}):this.$systemError("mixin","Target not a gene module.",t)}},{key:"getMode",value:function(){var t=[];return this.gene.mode.catchException&&t.push("try-catch-mode"),this.gene.mode.timeout&&t.push("timeout"),this.gene.mode.catchUncaughtException&&t.push("uncaught-exception-mode"),t}},{key:"close",value:function(){this.status.add("mode",this.getMode()),this.root.close(),this.gene.mode.catchUncaughtException&&"node"!==this.root.operating&&window.removeEventListener("error",this.uncaughtExceptionAction),this.gene.synthesis.termination&&this.gene.synthesis.termination.bind(this.case)(this.messenger,this.status)}},{key:"fail",value:function(t){!1===this.finish&&(this.finish=!0,this.status.set(!1,t),this.close(),this.reject({error:t,status:this.status,messenger:this.messenger}))}},{key:"exit",value:function(){!1===this.finish&&(this.finish=!0,this.status.set(!0),this.close(),this.resolve({status:this.status,messenger:this.messenger}))}},{key:"next",value:function(){var t=this;!1===this.finish&&(this.gene.synthesis.elongation&&this.gene.synthesis.elongation(this.messenger,this.bind.exit,this.bind.fail),setTimeout(function(){t.synthesis()},1))}},{key:"synthesis",value:function(){this.synthesisTryCatchMode()}},{key:"synthesisTryCatchMode",value:function(){if(this.gene.mode.catchException)try{this.synthesisCatchUncaughtExceptionMode()}catch(t){return this.status.add("catch",t.message),this.gene.mode.catchException&&this.gene.mode.catchException.action.bind(this.case)(this.messenger,t,this.bind.exit,this.bind.fail),!1}else this.synthesisCatchUncaughtExceptionMode()}},{key:"synthesisCatchUncaughtExceptionMode",value:function(){var t=this;this.gene.mode.catchUncaughtException&&"node"===this.root.operating?this.uncaughtExceptionDomain.run(function(){t.iterator.next()}):this.iterator.next()}}]),o}();return function(){function t(){_classCallCheck(this,t)}return _createClass(t,null,[{key:"addGroup",value:function(t,e,n){d.addGroup(t,e,n)}},{key:"hasCurriedFunction",value:function(t,e){return d.hasCurriedFunction(t,e)}},{key:"hasMethod",value:function(t,e){return d.hasMethod(t,e)}},{key:"hasGroup",value:function(t){return d.hasGroup(groupName,t)}},{key:"callMethod",value:function(t,e){return d.getMethod(t,e).use()}},{key:"callCurriedFunction",value:function(t,e){return d.getCurriedFunction(t,e).use()}},{key:"createMethodGroup",value:function(t){return new h(t)}},{key:"createGene",value:function(t){return new f(t)}}]),t}()});