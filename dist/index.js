"use strict";var _slicedToArray=function(t,e){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return function(t,e){var n=[],i=!0,s=!1,r=void 0;try{for(var o,a=t[Symbol.iterator]();!(i=(o=a.next()).done)&&(n.push(o.value),!e||n.length!==e);i=!0);}catch(t){s=!0,r=t}finally{try{!i&&a.return&&a.return()}finally{if(s)throw r}}return n}(t,e);throw new TypeError("Invalid attempt to destructure non-iterable instance")},_createClass=function(){function i(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(t,e,n){return e&&i(t.prototype,e),n&&i(t,n),t}}(),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};function _defineProperty(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function _toConsumableArray(t){if(Array.isArray(t)){for(var e=0,n=Array(t.length);e<t.length;e++)n[e]=t[e];return n}return Array.from(t)}function _asyncToGenerator(t){return function(){var a=t.apply(this,arguments);return new Promise(function(r,o){return function e(t,n){try{var i=a[t](n),s=i.value}catch(t){return void o(t)}if(!i.done)return Promise.resolve(s).then(function(t){e("next",t)},function(t){e("throw",t)});r(s)}("next")})}}function _possibleConstructorReturn(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function _inherits(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function _classCallCheck(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}!function(t,e){"undefined"!=typeof module&&"object"===("undefined"==typeof exports?"undefined":_typeof(exports))?module.exports=e():"function"==typeof define&&(define.amd||define.cmd)?define(function(){return e}):t.Nucleoid=e()}("undefined"!=typeof window?window:global,function(){var e=function(){function e(t){_classCallCheck(this,e),this.$moduleBase={name:t||"no name"}}return _createClass(e,[{key:"$systemError",value:function(t,e){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:"$_no_error";throw"$_no_error"!==n&&(console.log("%c error : ","color:#FFF; background:red"),console.log(n)),new Error("(☉д⊙)!! Nucleoid::"+this.$moduleBase.name+" => "+t+" -> "+e)}},{key:"$noKey",value:function(t,e,n){return null==e[n]||(this.$systemError(t,"Name already exists.",n),!1)}},{key:"$verify",value:function(t,e){var n=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},i={};for(var s in e){var r=e[s];if(r[0]&&null==t[s])return void this.$systemError("verify","Must required",s);t[s]?_typeof(r[1])!==("string"==typeof t[s]&&"#"===t[s][0])||t[s].slice(1)?i[s]=t[s]:this.$systemError("verify","Type("+_typeof(r[1])+") error",s):i[s]=r[1]}return Object.assign(i,n)}},{key:"$protection",value:function(t,e,n,i){var s=this;n[e]=i,Object.defineProperty(t,e,{set:function(){s.$systemError("protection","This key is a private key, can't be change.",e)},get:function(){return n[e]}})}}]),e}(),r=function t(){_classCallCheck(this,t)},i=function(t){function i(t,e){_classCallCheck(this,i);var n=_possibleConstructorReturn(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,"PollingEvent"));return n.name=e.name,n.status=new a(n.name,"polling"),n.action=e.action,n.finish=!1,t.status.addChildren(n.status),n}return _inherits(i,e),_createClass(i,[{key:"activate",value:function(){this.action(this.close.bind(this))}},{key:"close",value:function(){this.status.set(!0),this.finish=!0}}]),i}(),s=function(t){function i(t,e){_classCallCheck(this,i);var n=_possibleConstructorReturn(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,"Fragment"));return n.over=0,n.name=e||"no name",n.stop=!1,n.status=new a(n.name,"fragment"),n.thread=[],t.status.addChildren(n.status),n}return _inherits(i,e),_createClass(i,[{key:"install",value:function(e){var n=this;this.callback=function(t){t?n.status.set(!1,t):n.status.set(!0),e(t)}}},{key:"use",value:function(){return{add:this.add.bind(this),activate:this.activate.bind(this)}}},{key:"add",value:function(t){this.thread.push(this.$verify(t,{name:[!0,"#string"],action:[!0,"#function"]}))}},{key:"regsterError",value:function(e){var n=this;return function(t){!1===n.stop&&(e.set(!1,t),n.stop=!0,n.callback(t||"unknown error"))}}},{key:"regsterOnload",value:function(t){var e=this;return function(){t.set(!0),e.over+=1,!1===e.stop&&e.over>=e.thread.length&&(e.stop=!0,e.callback())}}},{key:"actionThread",value:function(s){var t,r=this;(t=_asyncToGenerator(regeneratorRuntime.mark(function t(){var e,n,i;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:e=new a(s.name,"thread"),n=r.regsterOnload(e),i=r.regsterError(e),r.status.addChildren(e),s.action(i,n);case 5:case"end":return t.stop()}},t,r)})),function(){return t.apply(this,arguments)})()}},{key:"activate",value:function(t){var e=this,n=this.thread.length;this.install(t);for(var i=0;i<n;i++)this.actionThread(this.thread[i]);0===n&&this.callback(null),this.activate=function(){e.$systemError("activate","This template("+e.name+") already  called")}}}]),i}(),o=function(t){function n(t){_classCallCheck(this,n);var e=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,"Root"));return e.gene=t,e.name=t.name,e.base={},e.delay=5,e.interval=null,e.operating="undefined"==typeof window?"node":"browser",e.rootStatus=new a(e.name,"root"),e.protection={},e.carryStatus=null,e.pollingEvents=[],e.initBase(),e}return _inherits(n,e),_createClass(n,[{key:"initPolling",value:function(){var i=this;this.interval=setInterval(function(){for(var t=!1,e=0;e<i.pollingEvents.length;e++){var n=i.pollingEvents[e];n.finish?t=!0:n.activate()}t&&i.clearPollingEvents()},this.delay)}},{key:"initBase",value:function(){if(this.gene.genetic){var t=this.gene.genetic();if("object"===(void 0===t?"undefined":_typeof(t)))for(var e in t)this.addBase(e,t[e]);else this.$systemError("initBase","Genetic retrun not a object",t)}}},{key:"getBase",value:function(){var t={};for(var e in this.base)t[e]=this.base[e];for(var n in this.protection)t[n]=this.protection[n];return t}},{key:"setTargetStatus",value:function(t){this.carryStatus=t}},{key:"createSystemStatus",value:function(t,e,n){var i=new a(t,"system");i.set(e,n),this.status.addChildren(i)}},{key:"addBase",value:function(t,e){null==this.base[t]?"$"===t.slice(0,1)?this.$protection(this.base,t,this.protection,e):this.base[t]=e:this.$systemError("addBase","Base key already exists.",t)}},{key:"polling",value:function(t){null==this.interval&&this.initPolling(),this.pollingEvents.push(new i(this,t))}},{key:"clearPollingEvents",value:function(){this.pollingEvents=this.pollingEvents.filter(function(t){return!1===t.finish})}},{key:"createFragment",value:function(t){return new s(this,t).use()}},{key:"close",value:function(t,e){this.rootStatus.set(t,e),this.interval&&clearInterval(this.interval)}},{key:"status",get:function(){return this.carryStatus||this.rootStatus}}]),n}(),n=function(){function e(t){_classCallCheck(this,e),this.name=t.name,this.base=t.base,this.gene=t.gene,this.status=t.rootStatus,this.success=t.rootStatus.success,this.getBase=t.getBase}return _createClass(e,[{key:"isError",value:function(){return!this.success}},{key:"getErrorMessage",value:function(){return this.isError?this.status.message:null}},{key:"getStatusToJson",value:function(){return this.status.json()}},{key:"getMode",value:function(){var t=[];return this.gene.mode.catchException&&t.push("try-catch-mode"),this.gene.mode.timeout&&t.push("timeout"),this.gene.mode.catchUncaughtException&&t.push("uncaught-exception-mode"),this.gene.mode.traceBase&&t.push("trace-base-mode"),t}}]),e}(),a=function(t){function i(t,e){_classCallCheck(this,i);var n=_possibleConstructorReturn(this,(i.__proto__||Object.getPrototypeOf(i)).call(this,"Status"));return n.name=t||"no name",n.type=e||"no type",n.message="",n.success=!1,n.children=[],n.startTime=Date.now(),n.attributes={},n.finishTime=null,n}return _inherits(i,e),_createClass(i,[{key:"addAttr",value:function(t,e){this.attributes[t]=e}},{key:"set",value:function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:"";return null==this.finishTime&&(this.success=t,this.message=e,this.finishTime=Date.now()),this}},{key:"get",value:function(){var t={name:this.name,type:this.type,message:this.message,success:this.success,attributes:this.attributes,operationTime:this.operationTime,totalOperationTime:0,children:[]},e=!0,n=!1,i=void 0;try{for(var s,r=this.children[Symbol.iterator]();!(e=(s=r.next()).done);e=!0){var o=s.value;t.children.push(o.get()),t.totalOperationTime+=o.operationTime}}catch(t){n=!0,i=t}finally{try{!e&&r.return&&r.return()}finally{if(n)throw i}}return t}},{key:"inspect",value:function(t){var e=1<arguments.length&&void 0!==arguments[1]?arguments[1]:[],n=Array.isArray(t)?[]:{};for(var i in t){var s=t[i],r=void 0===s?"undefined":_typeof(s);if("function"!==r)if("object"===r){var o=[t].concat(e);o.includes(s)?n[i]="Circular structure object.":n[i]=this.inspect(s,o)}else n[i]=s}return n}},{key:"json",value:function(){var t=this.inspect(this.get());return JSON.stringify(t,null,4)}},{key:"html",value:function(){return function t(e){var n='<div style="padding:5px; margin: 5px; border:solid 1px '+(e.success?"blue":"red")+'">';for(var i in n+="<div>type : "+e.type+"</div>",n+="<div>name : "+e.name+"</div>",n+="<div>operation time : "+e.operationTime+"</div>",n+="<div>total operation time : "+e.totalOperationTime+"</div>",n+=e.message?"<div>message : <br><pre>"+e.message+"</pre></div>":"",e.attributes)n+="<div> attributes("+i+") : ",n+="<pre>"+JSON.stringify(e.attributes[i],null,4)+"</pre>",n+="</div>";for(var s=e.children.length,r=0;r<s;r++)n+=t(e.children[r]);return n+="</div>"}(this.inspect(this.get()))}},{key:"addChildren",value:function(t){t instanceof i?this.children.push(t):this.$systemError("addChildren","Child not a status class.",t)}},{key:"operationTime",get:function(){return(this.finishTime||Date.now())-this.startTime}}]),i}(),c=function(t){function n(t){_classCallCheck(this,n);var e=_possibleConstructorReturn(this,(n.__proto__||Object.getPrototypeOf(n)).call(this,"Gene"));return e.setName(t||"no name"),e.templates=[],e.genetic=null,e.mode={timeout:null,traceBase:null,catchException:null,catchUncaughtException:null},e.synthesis={initiation:null,elongation:null,termination:null},e}return _inherits(n,e),_createClass(n,[{key:"setName",value:function(t){"string"==typeof t?this.name=t:this.$systemError("setName","Name not a string.",t)}},{key:"setTraceBaseMode",value:function(t,e){"boolean"==typeof t&&"function"==typeof e?t&&(this.mode.traceBase={action:e}):this.$systemError("setTraceBaseMode","Params type error. try setTraceBaseMode(boolean, function)")}},{key:"setTimeoutMode",value:function(t,e,n){"boolean"==typeof t&&"number"==typeof e&&"function"==typeof n?t&&(this.mode.timeout={action:n,millisecond:e}):this.$systemError("setTimeout","Params type error. try setTimeoutMode(boolean, number, function)")}},{key:"setCatchExceptionMode",value:function(t,e){"boolean"==typeof t&&"function"==typeof e?t&&(this.mode.catchException={action:e}):this.$systemError("setCatchExceptionMode","Params type error, try setCatchExceptionMode(boolean, function).")}},{key:"setCatchUncaughtExceptionMode",value:function(t,e){"boolean"==typeof t&&"function"==typeof e?t&&(this.mode.catchUncaughtException={action:e}):this.$systemError("setCatchUncaughtException","Params type error, try setCatchUncaughtException(boolean, function).")}},{key:"setGenetic",value:function(t){"function"==typeof t?this.genetic=t:this.$systemError("setGenetic","Params type error, try setGenetic(callback).")}},{key:"template",value:function(t,e){"string"==typeof t&&"function"==typeof e?this.templates.push({name:t,action:e}):this.$systemError("template","Params type error, try template(string, function).")}},{key:"setInitiation",value:function(t){"function"==typeof t?this.synthesis.initiation=t:this.$systemError("setInitiation","Params type error, try setInitiation(function).")}},{key:"setElongation",value:function(t){"function"==typeof t?this.synthesis.elongation=t:this.$systemError("setElongation","Params type error, try setElongation(function).")}},{key:"setTermination",value:function(t){"function"==typeof t?this.synthesis.termination=t:this.$systemError("setTermination","Params type error, try setTermination(function).")}},{key:"transcription",value:function(){var n=this;return new Promise(function(t,e){new u(n,t,e)})}}]),n}(),u=function(t){function s(t,e,n){_classCallCheck(this,s);var i=_possibleConstructorReturn(this,(s.__proto__||Object.getPrototypeOf(s)).call(this,"Transcription"));return i.gene=t,i.case=new r,i.root=new o(i.gene),i.finish=!1,i.reject=n,i.resolve=e,i.templates=i.gene.templates,i.init(),i.synthesis(),i}return _inherits(s,e),_createClass(s,[{key:"init",value:function(){this.initBind(),this.initTimeoutMode(),this.initGenerator(),this.initCatchUncaughtExceptionMode()}},{key:"initBind",value:function(){this.bind={exit:this.exit.bind(this),fail:this.fail.bind(this),next:this.next.bind(this),cross:this.cross.bind(this),addBase:this.root.addBase.bind(this.root),polling:this.root.polling.bind(this.root),setStatusAttr:this.setStatusAttr.bind(this),setRootStatusAttr:this.setRootStatusAttr.bind(this),createFragment:this.root.createFragment.bind(this.root)}}},{key:"initTimeoutMode",value:function(){var t=this;if(this.gene.mode.timeout){var e=this.gene.mode.timeout;this.timeoutSystem=setTimeout(function(){t.root.createSystemStatus("timeout",!0),e.action.bind(t.case)(t.base,t.bind.exit,t.bind.fail)},e.millisecond)}}},{key:"initCatchUncaughtExceptionMode",value:function(){var n=this;this.gene.mode.catchUncaughtException&&(this.uncaughtExceptionAction=function(t){var e=t.stack?t:t.error;n.root.createSystemStatus("uncaught exception",!0,e.stack),n.gene.mode.catchUncaughtException.action.bind(n.case)(n.base,e,n.bind.exit,n.bind.fail)},"node"===this.root.operating?(this.uncaughtExceptionDomain=require("domain").create(),this.uncaughtExceptionDomain.on("error",this.uncaughtExceptionAction)):window.addEventListener("error",this.uncaughtExceptionAction))}},{key:"initGenerator",value:function(){var s=this,t=regeneratorRuntime.mark(function t(){var n,i;return regeneratorRuntime.wrap(function(t){for(;;)switch(t.prev=t.next){case 0:if(n=1,i=s.templates[0],s.gene.synthesis.initiation)return s.gene.synthesis.initiation.bind(s.case)(s.base,s.getSkill(),s.bind.next,s.bind.exit,s.bind.fail),void(t.next=6);t.next=6;break;case 6:if(!(n<=1e4)){t.next=16;break}if(s.finish)return t.abrupt("break",16);t.next=11;break;case 11:null==i?s.bind.exit():function(){var t=new a(i.name,"template");s.root.status.addChildren(t),s.root.setTargetStatus(t);var e=function(){e=null,i=s.templates[n++],t.set(!0),s.bind.next(),s.root.setTargetStatus(null)};i.action.bind(s.case)(s.base,s.getSkill(),e,s.bind.exit,s.bind.fail)}();case 12:return void(t.next=14);case 14:t.next=6;break;case 16:return t.abrupt("return");case 17:case"end":return t.stop()}},t,this)});this.iterator=t()}},{key:"deepClone",value:function(e){var s=this,r=1<arguments.length&&void 0!==arguments[1]?arguments[1]:new WeakMap;if(Object(e)!==e)return e;if(e instanceof Set)return new Set(e);if(r.has(e))return r.get(e);var o=e instanceof Date?new Date(e):e instanceof RegExp?new RegExp(e.source,e.flags):Object.create(null);return r.set(e,o),e instanceof Map&&Array.from(e,function(t){var e=_slicedToArray(t,2),n=e[0],i=e[1];o.set(n,s.deepClone(i,r))}),Object.assign.apply(Object,[o].concat(_toConsumableArray(Object.keys(e).map(function(t){return _defineProperty({},t,s.deepClone(e[t],r))}))))}},{key:"getSkill",value:function(){return{cross:this.bind.cross,polling:this.bind.polling,addBase:this.bind.addBase,deepClone:this.deepClone,setStatusAttr:this.bind.setStatusAttr,setRootStatusAttr:this.bind.setRootStatusAttr,createFragment:this.bind.createFragment}}},{key:"setRootStatusAttr",value:function(t,e){this.root.rootStatus.addAttr(t,e)}},{key:"setStatusAttr",value:function(t,e){this.status.addAttr(t,e)}},{key:"cross",value:function(t,e){var n=this;t instanceof c?t.transcription().then(function(t){n.root.status.addChildren(t.status),e(null,t)},function(t){n.root.status.addChildren(t.status),e(t.getErrorMessage(),t)}):this.$systemError("cross","Target not a gene module.",t)}},{key:"close",value:function(t,e){this.root.close(t,e),this.timeoutSystem&&clearTimeout(this.timeoutSystem),this.gene.mode.catchUncaughtException&&"node"!==this.root.operating&&window.removeEventListener("error",this.uncaughtExceptionAction),this.gene.synthesis.termination&&this.gene.synthesis.termination.bind(this.case)(this.base,this.root.rootStatus)}},{key:"fail",value:function(t){!1===this.finish&&(this.finish=!0,this.close(!1,t||"unknown error"),this.reject(new n(this.root)))}},{key:"exit",value:function(t){!1===this.finish&&(this.finish=!0,this.close(!0,t),this.resolve(new n(this.root)))}},{key:"next",value:function(){var t=this;!1===this.finish&&(this.gene.mode.traceBase&&this.gene.mode.traceBase.action(this.deepClone(this.root.base),this.status),this.gene.synthesis.elongation&&this.gene.synthesis.elongation(this.base,this.bind.exit,this.bind.fail),setTimeout(function(){t.synthesis()},1))}},{key:"synthesis",value:function(){this.synthesisTryCatchMode()}},{key:"synthesisTryCatchMode",value:function(){if(this.gene.mode.catchException)try{this.synthesisCatchUncaughtExceptionMode()}catch(t){return this.gene.mode.catchException&&(this.root.createSystemStatus("error catch",!0,t.stack),this.gene.mode.catchException.action.bind(this.case)(this.base,t,this.bind.exit,this.bind.fail)),!1}else this.synthesisCatchUncaughtExceptionMode()}},{key:"synthesisCatchUncaughtExceptionMode",value:function(){var t=this;this.gene.mode.catchUncaughtException&&"node"===this.root.operating?this.uncaughtExceptionDomain.run(function(){t.iterator.next()}):this.iterator.next()}},{key:"status",get:function(){return this.root.status}},{key:"base",get:function(){return this.root.base}}]),s}();return function(){function t(){_classCallCheck(this,t)}return _createClass(t,null,[{key:"createGene",value:function(t){return new c(t)}}]),t}()});